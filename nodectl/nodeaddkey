#!/usr/local/bin/cbsd
#v11.0.0
CBSDMODULE="node"
MYARG="md5name ip port"
MYOPTARG="cbsdkeyfile pw"
MYDESC="Get rsa get from remote node"

. ${subr}

. ${cbsdinit}

. ${nodes}

[ -z "${cbsdkeyfile}" -a -z "${pw}" ] && err 1 "${MAGENTA}nodeaddkey: ${GREEN}pw=${MAGENTA} or ${GREEN}cbsdkeyfile=${MAGENTA} is mandatory${NORMAL}"

LOCALKEY="${rsshdir}/${md5name}.id_rsa"
REMOTEKEY=".ssh/${md5name}.id_rsa"

iptype ${ip} >/dev/null 2>&1
_ret=$?

# if natip is not valid IPv4, assume it is NIC variable.
# so try to find out first IPv4 for aliasing
case ${_ret} in
	1)
		if [ -n "${cbsdkeyfile}" ]; then
			# key-based auth
			CBSD_SFTP_CMD="/usr/bin/scp -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -oBatchMode=yes -oPort=${port} -i ${cbsdkeyfile} ${cbsduser}@${ip}:${REMOTEKEY} ${LOCALKEY}"
		else
			# pw-based auth
			CBSD_SFTP_CMD="cbsdsftp ${ip} ${port} ${cbsduser} ${pw} ${REMOTEKEY} ${LOCALKEY}"
		fi
		;;
	2)
		if [ -n "${cbsdkeyfile}" ]; then
			# key-based auth
			CBSD_SFTP_CMD="/usr/bin/scp -6 -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -oBatchMode=yes -oPort=${port} -i ${cbsdkeyfile} ${cbsduser}@${ip}:${REMOTEKEY} ${LOCALKEY}"
		else
			CBSD_SFTP_CMD="cbsdsftp6 ${ip} ${port} ${cbsduser} ${pw} ${REMOTEKEY} ${LOCALKEY}"
		fi
		;;
	*)
		err 1 "${MAGENTA}nodeaddkey: unknown IP type: ${GREEN}${ip}${NORMAL}"
	;;
esac

${CBSD_SFTP_CMD}
RESULT=$?

case ${RESULT} in
	0)
		/bin/chmod 0400 ${LOCALKEY}
		/usr/sbin/chown ${cbsduser}:${cbsduser} ${LOCALKEY}
		err 0 "${MAGENTA}Key has been added succesful:${GREEN} ${LOCALKEY}${NORMAL}"
		;;
	1)
		err 1 "${MAGENTA}Bad user or password.${NORMAL}"
		;;
	2)
		err 2 "${MAGENTA}No such key on remote host:${GREEN} ${REMOTEKEY}${NORMAL}"
		;;
	*)
		err 3 "${MAGENTA}Unknown error.${NORMAL}"
		;;
esac
