#!/bin/sh
# HowTo/Sample how to create micro (~30 MB) FreeBSD bhyve guest
cbsd jremove micro1 || true
cbsd jcreate jname=micro1 baserw=1 ver=empty applytpl=0
cbsd copy-binlib basedir=/ chaselibs=1 dstdir=/usr/jails/jails-data/micro1-data filelist=/usr/local/cbsd/share/FreeBSD-microbhyve.txt.xz
cbsd sysrc jname=micro1 sshd_flags="-oUseDNS=no -oPermitRootLogin=yes" sshd_enable=YES ifconfig_vtnet0="inet 10.0.100.10/24 up" defaultrouter="10.0.100.1"
cp -a /etc/ssh /usr/jails/jails-data/micro1-data/etc/
cp -a /etc/gss /usr/jails/jails-data/micro1-data/etc/
cp -a /etc/pam.d /usr/jails/jails-data/micro1-data/etc/
mkdir -p /usr/jails/jails-data/micro1-data/var/empty /usr/jails/jails-data/micro1-data/var/log /usr/jails/jails-data/micro1-data/var/run /usr/jails/jails-data/micro1-data/root /usr/jails/jails-data/micro1-data/dev
chmod 0700 /usr/jails/jails-data/micro1-data/var/empty
pw -R /usr/jails/jails-data/micro1-data usermod root -s /bin/sh

# cbsd kernel name=BHYVE

[ ! -d /usr/jails/jails-data/micro1-data ] && rm -rf /usr/jails/jails-data/micro1-data
cp -a /usr/jails/basejail/base_amd64_amd64_14.0/boot /usr/jails/jails-data/micro1-data/

# network
cat > /usr/jails/jails-data/micro1-data/etc/rc.local <<EOF
/sbin/ifconfig vtnet0 inet 10.0.100.10/24 up
/sbin/route add default 10.0.100.1
EOF

#  [name=BHYVE]
cbsd jail2iso jname=micro1 dstdir=/tmp media=bhyve freesize=32m ver=14.0 efi=1
