#!/usr/local/bin/cbsd
#v12.1.6
# !WIP, not ready yet
#
MYARG="old new jname"
MYDESC="Upgrade jail base data when baserw=1"
CBSDMODULE="jail"

. ${subr}
. ${strings}
. ${distdir}/universe.subr
readconf buildworld.conf

. ${cbsdinit}

. ${jrcconf}

[ $? -eq 1 ] && err 1 "${N1_COLOR}No such jail: ${N2_COLOR}${jname}${N0_COLOR}"
[ "${emulator}" = "bhyve" ] && err 1 "${N1_COLOR}Not for bhyve mode${N0_COLOR}"

. ${system}
init_target_arch
init_basedir
get_base -v ${new}

etcupdate_jail_root="${jailsysdir}/${jname}/etcupdate"

[ ! -d ${etcupdate_jail_root} ] && ${MKDIR_CMD} -p ${etcupdate_jail_root}

[ ! -d "${etcupdate_jail_root}/old" ] && ${MKDIR_CMD} ${etcupdate_jail_root}/old
[ ! -d "${etcupdate_jail_root}/current" ] && ${MKDIR_CMD} ${etcupdate_jail_root}/current

if [ ! -d "${jailsysdir}/${jname}/etc.orig" ]; then
	# echo "etc.orig directory DOES NOT exist, it will be copied from base"
	${CP_CMD} -R /usr/jails/basejail/base_amd64_amd64_${old}/etc/. ${jailsysdir}/${jname}/etc.orig
fi
if [ ! -f "${data}/var/db/zoneinfo" ]; then
	# echo "/var/db/zoneinfo DOES NOT exist in jail, it will be copied from host"
	${CP_CMD} /var/db/zoneinfo ${data}/var/db/zoneinfo
fi

${MOUNT_CMD} -t nullfs -oro /usr/jails/basejail/base_amd64_amd64_${old} ${etcupdate_jail_root}/old
${MOUNT_CMD} -t nullfs -oro ${jailsysdir}/${jname}/etc.orig ${etcupdate_jail_root}/old/etc
${MOUNT_CMD} -t nullfs -oro /usr/jails/basejail/base_amd64_amd64_${new} ${etcupdate_jail_root}/current
echo "etcupdate -F -d ${etcupdate_jail_root} -r -D ${path} -I '/root/*' -I '/etc/hosts'"
