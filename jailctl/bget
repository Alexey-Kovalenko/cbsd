#!/usr/local/bin/cbsd
#v12.0.12
CBSDMODULE="bhyve"
MYARG="jname"

unset jname

. ${subr}
. ${strings}

[ ! -r ${distsharedir}/bhyve_settings.conf ] && err 1 "${N1_COLOR}bset: no such file: ${N2_COLOR}${distsharedir}/bhyve_settings.conf${N0_COLOR}";
. ${distsharedir}/bhyve_settings.conf

MYOPTARG="${MYCOL} mode"
#mode=quiet
MYDESC="Get info related to bhyve domain"
ADDHELP="mode=quiet - return only value, without other string\nall - Returns all settings. Not compatible with mode=quiet.\n"
. ${cbsdinit}

[ -z "${jname}" ] && err 1 "Give me jname"
. ${jrcconf}
if [ $? -eq 1 ]; then
	#
	# try_remote, todo
	sqlfile_sysdir="${tmpdir}/${1}"
	err 1 "${N1_COLOR}No such bhyve: ${N2_COLOR}${jname}${N0_COLOR}"
else
	sqlfile_sysdir="${jailsysdir}"
fi
[ "${emulator}" != "bhyve" ] && err 1 "${N1_COLOR}not bhyve engine, emulator: ${N2_COLOR}${emulator}${N0_COLOR}"
QUIET=0
[ "${mode}" = "quiet" ] && QUIET=1

shift

ALL_ARGS="created astart vm_cpus vm_ram vm_os_type \
                vm_boot vm_os_profile bhyve_flags vm_vnc_port \
                virtio_type bhyve_vnc_tcp_bind bhyve_vnc_resolution \
                cd_vnc_wait protected hidden maintenance ip4_addr \
                vnc_password state_time vm_hostbridge vm_iso_path \
                vm_console vm_efi vm_rd_port bhyve_generate_acpi \
                bhyve_wire_memory bhyve_rts_keeps_utc bhyve_force_msi_irq \
                bhyve_x2apic_mode bhyve_mptable_gen bhyve_ignore_msr_acc \
                bhyve_vnc_vgaconf media_auto_eject vm_cpu_topology \
                debug_engine xhci cd_boot_firmware jailed vm_iso_path2 \
                on_poweroff on_reboot on_crash vnc_port vm_zfs_guid soundhw \
                bhyve_cmd"

if [ -z ${1} ]; then
        ARGS=${ALL_ARGS}
elif [ ${1} = "all" ]; then
        ARGS=${ALL_ARGS}
else
        ARGS=${@}
fi


for OID in ${ARGS}; do
	_pref5=$( substr --pos=0 --len=5 --str=${OID} )
	[ "${_pref5}" = "mode=" ] && continue

	case "${OID}" in
		vnc)
			_vnc_port=$( cbsdsqlro ${sqlfile_sysdir}/${jname}/local.sqlite "SELECT vnc_port FROM settings LIMIT 1" )
			_bhyve_vnc_tcp_bind=$( cbsdsqlro ${sqlfile_sysdir}/${jname}/local.sqlite "SELECT bhyve_vnc_tcp_bind FROM settings LIMIT 1" )
			val="${_bhyve_vnc_tcp_bind}:${_vnc_port}"
			;;
		*)
			val=$( cbsdsqlro ${sqlfile_sysdir}/${jname}/local.sqlite "SELECT ${OID} FROM settings LIMIT 1" )
			;;
	esac

	if [ ${QUIET} -eq 1 ]; then
		echo "${val}"
	else
		echo "${OID}: ${val}"
	fi
done
